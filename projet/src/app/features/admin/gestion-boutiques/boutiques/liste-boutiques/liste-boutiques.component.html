<div class="page-container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-left">
      <h1>
        <i class="fas fa-store"></i>
        Gestion des boutiques
      </h1>
      <nav class="breadcrumb">
        <a routerLink="/admin/dashboard">Dashboard</a>
        <i class="fas fa-chevron-right"></i>
        <span>Gestion Boutiques</span>
        <i class="fas fa-chevron-right"></i>
        <span class="current">Liste des boutiques</span>
      </nav>
    </div>
    <div class="header-right">
      <button class="btn btn-primary" routerLink="/admin/boutiques/boutiques/creer">
        <i class="fas fa-plus-circle"></i>
        Nouvelle boutique
      </button>
    </div>
  </div>

  <!-- Alert Messages -->
  <div class="alert alert-success" *ngIf="successMessage">
    <i class="fas fa-check-circle"></i>
    {{ successMessage }}
  </div>

  <div class="alert alert-danger" *ngIf="errorMessage">
    <i class="fas fa-exclamation-circle"></i>
    {{ errorMessage }}
  </div>

  <!-- Stats Cards -->
  <div class="stats-grid">
    <div class="stat-card total">
      <div class="stat-icon">
        <i class="fas fa-store"></i>
      </div>
      <div class="stat-content">
        <h3>{{ stats.total }}</h3>
        <p>Total boutiques</p>
      </div>
    </div>

    <div class="stat-card active">
      <div class="stat-icon">
        <i class="fas fa-check-circle"></i>
      </div>
      <div class="stat-content">
        <h3>{{ stats.actives }}</h3>
        <p>Actives</p>
      </div>
    </div>

    <div class="stat-card inactive">
      <div class="stat-icon">
        <i class="fas fa-times-circle"></i>
      </div>
      <div class="stat-content">
        <h3>{{ stats.inactives }}</h3>
        <p>Inactives</p>
      </div>
    </div>

    <div class="stat-card paye">
      <div class="stat-icon">
        <i class="fas fa-check-circle"></i>
      </div>
      <div class="stat-content">
        <h3>{{ stats.payees }}</h3>
        <p>Payées</p>
      </div>
    </div>

    <div class="stat-card impaye">
      <div class="stat-icon">
        <i class="fas fa-exclamation-circle"></i>
      </div>
      <div class="stat-content">
        <h3>{{ stats.impayees }}</h3>
        <p>Impayées</p>
      </div>
    </div>
  </div>

  <!-- Filters Card -->
  <div class="filters-card">
    <div class="filters-header">
      <h3>
        <i class="fas fa-filter"></i>
        Filtres
      </h3>
      <button class="btn-clear" (click)="clearFilters()" *ngIf="hasActiveFilters()">
        <i class="fas fa-times"></i>
        Effacer tous les filtres
      </button>
    </div>

    <div class="filters-body">
      <!-- Recherche textuelle -->
      <div class="filter-row">
        <div class="search-box full-width">
          <i class="fas fa-search"></i>
          <input
            type="text"
            [(ngModel)]="searchTerm"
            (input)="onSearch()"
            placeholder="Rechercher une boutique par nom, description ou slogan..."
            class="form-control"
          >
        </div>
      </div>

      <!-- Filtres de base -->
      <div class="filter-row">
        <div class="filter-group">
          <label>
            <i class="fas fa-tags"></i>
            Catégorie
          </label>
          <select [(ngModel)]="selectedCategorie" (change)="onFilterChange()" class="form-control">
            <option value="">Toutes les catégories</option>
            <option *ngFor="let cat of categories" [value]="cat._id">
              {{ cat.nom_categorie }}
            </option>
          </select>
        </div>

        <div class="filter-group">
          <label>
            <i class="fas fa-power-off"></i>
            Statut
          </label>
          <select [(ngModel)]="selectedStatut" (change)="onFilterChange()" class="form-control">
            <option *ngFor="let opt of statutOptions" [value]="opt.value">
              {{ opt.label }}
            </option>
          </select>
        </div>

        <div class="filter-group">
          <label>
            <i class="fas fa-credit-card"></i>
            Paiement
          </label>
          <select [(ngModel)]="selectedPaiement" (change)="onFilterChange()" class="form-control">
            <option *ngFor="let opt of paiementOptions" [value]="opt.value">
              {{ opt.label }}
            </option>
          </select>
        </div>
      </div>

      <!-- Filtre par note (min/max) -->
      <div class="filter-row">
        <div class="filter-group range-filter">
          <label>
            <i class="fas fa-star" style="color: #ffc107;"></i>
            Note minimum
          </label>
          <input
            type="number"
            [(ngModel)]="noteMin"
            (input)="onFilterChange()"
            placeholder="Min (0-5)"
            min="0"
            max="5"
            step="0.1"
            class="form-control"
          >
        </div>

        <div class="filter-group range-filter">
          <label>
            <i class="fas fa-star" style="color: #ffc107;"></i>
            Note maximum
          </label>
          <input
            type="number"
            [(ngModel)]="noteMax"
            (input)="onFilterChange()"
            placeholder="Max (0-5)"
            min="0"
            max="5"
            step="0.1"
            class="form-control"
          >
        </div>
      </div>

      <!-- Filtre par date de création -->
      <div class="filter-row">
        <div class="filter-group date-filter">
          <label>
            <i class="fas fa-calendar-alt" style="color: #667eea;"></i>
            Date de début
          </label>
          <input
            type="date"
            [(ngModel)]="dateDebut"
            (change)="onFilterChange()"
            class="form-control"
          >
        </div>

        <div class="filter-group date-filter">
          <label>
            <i class="fas fa-calendar-alt" style="color: #667eea;"></i>
            Date de fin
          </label>
          <input
            type="date"
            [(ngModel)]="dateFin"
            (change)="onFilterChange()"
            class="form-control"
          >
        </div>
      </div>

      <!-- Indicateur de filtres actifs -->
      <div class="active-filters" *ngIf="hasActiveFilters()">
        <span class="active-filters-label">Filtres actifs:</span>
        <span class="active-filter-tag" *ngIf="searchTerm">
          <i class="fas fa-search"></i> "{{ searchTerm }}"
        </span>
        <span class="active-filter-tag" *ngIf="selectedCategorie">
          <i class="fas fa-tags"></i> {{ getCategorieNameById(selectedCategorie) }}
        </span>
        <span class="active-filter-tag" *ngIf="selectedStatut === 'true'">
          <i class="fas fa-check-circle"></i> Actif
        </span>
        <span class="active-filter-tag" *ngIf="selectedStatut === 'false'">
          <i class="fas fa-times-circle"></i> Inactif
        </span>
        <span class="active-filter-tag" *ngIf="selectedPaiement === 'paye'">
          <i class="fas fa-check-circle"></i> Payé
        </span>
        <span class="active-filter-tag" *ngIf="selectedPaiement === 'impaye'">
          <i class="fas fa-exclamation-circle"></i> Impayé
        </span>
        <span class="active-filter-tag" *ngIf="noteMin !== null">
          <i class="fas fa-star"></i> Note ≥ {{ noteMin }}
        </span>
        <span class="active-filter-tag" *ngIf="noteMax !== null">
          <i class="fas fa-star"></i> Note ≤ {{ noteMax }}
        </span>
        <span class="active-filter-tag" *ngIf="dateDebut">
          <i class="fas fa-calendar-alt"></i> Du {{ dateDebut | date:'dd/MM/yyyy' }}
        </span>
        <span class="active-filter-tag" *ngIf="dateFin">
          <i class="fas fa-calendar-alt"></i> Au {{ dateFin | date:'dd/MM/yyyy' }}
        </span>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-state" *ngIf="loading">
    <div class="spinner"></div>
    <p>Chargement des boutiques...</p>
  </div>

  <!-- Boutiques Grid -->
  <div class="boutiques-grid" *ngIf="!loading">
    <div class="boutique-card" *ngFor="let boutique of filteredBoutiques">
      <!-- En-tête de la carte avec logo -->
      <div class="card-header">
        <div class="logo-wrapper">
          <img [src]="getLogoUrl(boutique.logo_url)" 
            [alt]="boutique.nom" 
            (error)="onLogoError($event)"
            class="boutique-logo">
        </div>
        <div class="header-info">
          <h3 class="boutique-nom">{{ boutique.nom }}</h3>
          <span class="boutique-categorie">{{ getCategorieName(boutique.categorie) }}</span>
        </div>
        <div class="header-badges">
          <span class="badge statut" [ngClass]="boutique.est_active ? 'active' : 'inactive'">
            <i class="fas" [class.fa-check-circle]="boutique.est_active" [class.fa-times-circle]="!boutique.est_active"></i>
            {{ boutique.est_active ? 'Active' : 'Inactive' }}
          </span>
          <span class="badge paiement" [ngClass]="getStatutPaiementClass(boutique.statut_paiement)">
            <i class="fas" [ngClass]="getStatutPaiementIcon(boutique.statut_paiement)"></i>
            {{ getStatutPaiementText(boutique.statut_paiement) }}
          </span>
        </div>
      </div>

      <!-- Informations gérant -->
      <div class="gerant-info">
        <i class="fas fa-user-tie"></i>
        <div class="gerant-details">
          <span class="gerant-nom">{{ getGerantName(boutique.gerant) }}</span>
          <span class="gerant-email" *ngIf="getGerantEmail(boutique.gerant)">
            {{ getGerantEmail(boutique.gerant) }}
          </span>
        </div>
      </div>

      <!-- Contact -->
      <div class="contact-info" *ngIf="boutique.contact">
        <div class="contact-item" *ngIf="boutique.contact.email">
          <i class="fas fa-envelope"></i>
          <span>{{ boutique.contact.email }}</span>
        </div>
        <div class="contact-item" *ngIf="boutique.contact.telephone">
          <i class="fas fa-phone"></i>
          <span>{{ boutique.contact.telephone }}</span>
        </div>
      </div>

      <!-- Note moyenne (seule) -->
      <div class="stats">
        <div class="note-item">
          <i class="fas fa-star"></i>
          <span class="note-valeur">{{ boutique.statistiques.note_moyenne.toFixed(1) }}</span>
          <span class="note-sur">/5</span>
        </div>
      </div>

      <!-- Date d'ouverture -->
      <div class="date-info">
        <i class="fas fa-calendar-alt"></i>
        <span>Ouverte le {{ formatDate(boutique.date_ouverture) }}</span>
      </div>

      <!-- Actions -->
      <div class="card-actions">
        <button class="btn-view" (click)="onViewDetails(boutique._id)" title="Voir détails">
          <i class="fas fa-eye"></i>
          Voir détails
        </button>
        <button class="btn-edit" (click)="onEdit(boutique._id)" title="Modifier">
          <i class="fas fa-edit"></i>
          Modifier
        </button>
        <button class="btn-toggle" 
                [ngClass]="boutique.est_active ? 'active' : 'inactive'"
                (click)="onToggleStatus(boutique)"
                [title]="boutique.est_active ? 'Désactiver' : 'Activer'">
          <i class="fas" [class.fa-toggle-on]="boutique.est_active" [class.fa-toggle-off]="!boutique.est_active"></i>
          {{ boutique.est_active ? 'Désactiver' : 'Activer' }}
        </button>
        <button class="btn-delete" (click)="onDelete(boutique._id)" title="Supprimer">
          <i class="fas fa-trash"></i>
          Supprimer
        </button>
      </div>
    </div>

    <!-- Empty State -->
    <div class="empty-state" *ngIf="filteredBoutiques.length === 0">
      <div class="empty-icon">
        <i class="fas fa-store"></i>
      </div>
      <h3>Aucune boutique trouvée</h3>
      <p>
        {{ hasActiveFilters() ? 
           'Aucune boutique ne correspond à vos critères de recherche.' : 
           'Commencez par créer votre première boutique.' }}
      </p>
      <button class="btn btn-primary" routerLink="/admin/boutiques/boutiques/creer" *ngIf="!hasActiveFilters()">
        <i class="fas fa-plus-circle"></i>
        Créer une boutique
      </button>
      <button class="btn btn-secondary" (click)="clearFilters()" *ngIf="hasActiveFilters()">
        <i class="fas fa-times"></i>
        Effacer les filtres
      </button>
    </div>
  </div>

  <!-- Pagination -->
  <app-pagination
    *ngIf="!loading && totalPages > 1"
    [currentPage]="currentPage"
    [totalPages]="totalPages"
    [totalItems]="totalDocs"
    [limit]="limit"
    [hasPrevPage]="hasPrevPage"
    [hasNextPage]="hasNextPage"
    (pageChange)="onPageChange($event)">
  </app-pagination>
</div>