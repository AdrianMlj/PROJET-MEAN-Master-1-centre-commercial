<div class="page-container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-left">
      <h1>
        <i class="fas fa-edit"></i>
        Modifier la boutique
      </h1>
      <nav class="breadcrumb">
        <a routerLink="/admin/dashboard">Dashboard</a>
        <i class="fas fa-chevron-right"></i>
        <a routerLink="/admin/boutiques/boutiques/liste">Boutiques</a>
        <i class="fas fa-chevron-right"></i>
        <a [routerLink]="['/admin/boutiques/boutiques/details', boutiqueId]">Détails</a>
        <i class="fas fa-chevron-right"></i>
        <span class="current">{{ boutique?.nom || 'Modification' }}</span>
      </nav>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-state" *ngIf="loadingBoutique">
    <div class="spinner"></div>
    <p>Chargement des informations...</p>
  </div>

  <!-- Form Card -->
  <div class="content-wrapper" *ngIf="!loadingBoutique">
    <div class="form-card">
      <!-- En-tête -->
      <div class="form-header">
        <div class="form-icon">
          <i class="fas fa-store"></i>
        </div>
        <div class="form-title">
          <h2>{{ boutique?.nom }}</h2>
          <p>Modifiez les informations de la boutique</p>
        </div>
        <div class="status-indicator" [ngClass]="boutique?.est_active ? 'active' : 'inactive'">
          <i class="fas" [class.fa-check-circle]="boutique?.est_active" [class.fa-times-circle]="!boutique?.est_active"></i>
          {{ boutique?.est_active ? 'Active' : 'Inactive' }}
        </div>
      </div>

      <!-- Formulaire -->
      <form [formGroup]="boutiqueForm" (ngSubmit)="onSubmit()" class="modern-form" novalidate>
        
        <!-- Messages -->
        <div class="alert alert-success" *ngIf="successMessage">
          <i class="fas fa-check-circle"></i>
          {{ successMessage }}
        </div>

        <div class="alert alert-danger" *ngIf="errorMessage">
          <i class="fas fa-exclamation-circle"></i>
          {{ errorMessage }}
        </div>

        <!-- Informations de base -->
        <div class="form-section">
          <h3>
            <i class="fas fa-info-circle"></i>
            Informations de base
          </h3>

          <!-- Nom -->
          <div class="form-group">
            <label for="nom">
              <i class="fas fa-store"></i>
              Nom de la boutique *
            </label>
            <input
              type="text"
              id="nom"
              formControlName="nom"
              class="form-control"
              [ngClass]="{
                'is-invalid': boutiqueForm.get('nom')?.touched && boutiqueForm.get('nom')?.invalid
              }"
            >
            <div class="error-message" *ngIf="boutiqueForm.get('nom')?.touched && boutiqueForm.get('nom')?.invalid">
              <span *ngIf="boutiqueForm.get('nom')?.errors?.['required']">Le nom est requis</span>
              <span *ngIf="boutiqueForm.get('nom')?.errors?.['minlength']">Minimum 2 caractères</span>
              <span *ngIf="boutiqueForm.get('nom')?.errors?.['maxlength']">Maximum 100 caractères</span>
            </div>
          </div>

          <!-- Catégorie -->
          <div class="form-group">
            <label for="categorie">
              <i class="fas fa-tags"></i>
              Catégorie *
            </label>
            <select
              id="categorie"
              formControlName="categorie"
              class="form-control"
              [ngClass]="{
                'is-invalid': boutiqueForm.get('categorie')?.touched && boutiqueForm.get('categorie')?.invalid
              }"
            >
              <option value="" disabled>Sélectionnez une catégorie</option>
              <option *ngFor="let cat of categories" [value]="cat._id">
                {{ cat.nom_categorie }}
              </option>
            </select>
            <div class="error-message" *ngIf="boutiqueForm.get('categorie')?.touched && boutiqueForm.get('categorie')?.invalid">
              La catégorie est requise
            </div>
          </div>

          <!-- ✅ NOUVEAU: Gérant avec recherche -->
          <div class="form-group">
            <label for="gerant">
              <i class="fas fa-user-tie"></i>
              Gérant de la boutique *
            </label>
            
            <div class="gerant-search" [class.has-value]="selectedGerant">
              <div class="search-input-wrapper">
                <i class="fas fa-search search-icon"></i>
                <input
                  type="text"
                  class="form-control"
                  placeholder="Rechercher un gérant par nom, prénom ou email..."
                  [value]="searchTerm"
                  (input)="onSearchGerant($event)"
                  (focus)="showGerantDropdown = true"
                  [disabled]="!!selectedGerant"
                >
                <button 
                  type="button" 
                  class="clear-btn" 
                  *ngIf="selectedGerant"
                  (click)="clearGerant()"
                  title="Changer de gérant"
                >
                  <i class="fas fa-times"></i>
                </button>
              </div>

              <!-- Résultats de recherche -->
              <div class="gerant-dropdown" *ngIf="showGerantDropdown && !selectedGerant">
                <div class="dropdown-header">
                  <span *ngIf="loadingGerants">
                    <i class="fas fa-spinner fa-spin"></i> Recherche en cours...
                  </span>
                  <span *ngIf="!loadingGerants && gerants.length === 0 && searchTerm.length >= 2">
                    Aucun gérant disponible trouvé
                  </span>
                  <span *ngIf="searchTerm.length < 2">
                    Tapez au moins 2 caractères
                  </span>
                </div>
                
                <div class="dropdown-list" *ngIf="gerants.length > 0">
                  <div 
                    class="dropdown-item" 
                    *ngFor="let gerant of gerants"
                    (click)="selectGerant(gerant)"
                  >
                    <div class="item-avatar">
                      <i class="fas fa-user-circle"></i>
                    </div>
                    <div class="item-info">
                      <div class="item-name">
                        {{ gerant.prenom }} {{ gerant.nom }}
                      </div>
                      <div class="item-email">{{ gerant.email }}</div>
                      <div class="item-phone" *ngIf="gerant.telephone">
                        <i class="fas fa-phone"></i> {{ gerant.telephone }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Gérant sélectionné -->
              <div class="selected-gerant" *ngIf="selectedGerant">
                <div class="selected-gerant-info">
                  <div class="selected-avatar">
                    <i class="fas fa-user-circle"></i>
                  </div>
                  <div class="selected-details">
                    <strong>{{ selectedGerant.prenom }} {{ selectedGerant.nom }}</strong>
                    <span>{{ selectedGerant.email }}</span>
                    <span *ngIf="selectedGerant.telephone" class="selected-phone">
                      <i class="fas fa-phone"></i> {{ selectedGerant.telephone }}
                    </span>
                  </div>
                </div>
              </div>
            </div>

            <input type="hidden" formControlName="gerant">
            <div class="error-message" *ngIf="boutiqueForm.get('gerant')?.touched && boutiqueForm.get('gerant')?.invalid">
              Le gérant est requis
            </div>
          </div>
        </div>

        <!-- Statut -->
        <div class="form-section">
          <h3>
            <i class="fas fa-toggle-on"></i>
            Statut
          </h3>

          <div class="form-group">
            <div class="toggle-switch">
              <label class="switch">
                <input type="checkbox" formControlName="est_active">
                <span class="slider round"></span>
              </label>
              <span class="toggle-label" [ngClass]="boutiqueForm.get('est_active')?.value ? 'text-success' : 'text-danger'">
                <i class="fas" [class.fa-check-circle]="boutiqueForm.get('est_active')?.value" 
                   [class.fa-times-circle]="!boutiqueForm.get('est_active')?.value"></i>
                {{ boutiqueForm.get('est_active')?.value ? 'Boutique active' : 'Boutique inactive' }}
              </span>
            </div>
            <small class="form-text">
              Les boutiques inactives ne sont pas visibles par les acheteurs
            </small>
          </div>
        </div>

        <!-- Actions -->
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="annuler()" [disabled]="loading">
            <i class="fas fa-times"></i>
            Annuler
          </button>
          <button type="submit" class="btn btn-primary" [disabled]="boutiqueForm.invalid || loading">
            <i class="fas fa-spinner fa-spin" *ngIf="loading"></i>
            <i class="fas fa-save" *ngIf="!loading"></i>
            {{ loading ? 'Modification...' : 'Enregistrer les modifications' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>